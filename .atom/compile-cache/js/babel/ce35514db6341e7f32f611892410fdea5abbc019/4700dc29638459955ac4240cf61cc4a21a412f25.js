Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;
exports.enabledForPlatform = enabledForPlatform;
/** @babel */

var _atom = require('atom');

var dockWorkaroundElements = [null, null];
var dockWorkaroundObservers = [null, null];
var dockWorkaroundTimeout = [null, null];
var leftDockVisible = false;
var subs = null;

function activate(state) {
  if (!enabledForPlatform(process.platform)) return;
  subs = new _atom.CompositeDisposable();

  document.body.classList.add('no-title-bar');
  subs.add(new _atom.Disposable(function () {
    setPadding(null);
    document.body.classList.remove('no-title-bar');
  }));

  // wait to finish package initialization until atom is fully loaded
  var mutationObserver = new MutationObserver(function (mutations) {
    if (mutationObserver) mutationObserver.disconnect();
    mutationObserver = null;
    finishInitialize();
  });
  mutationObserver.observe(atom.views.getView(atom.workspace), { attributes: true });
}

function deactivate() {
  if (subs) subs.dispose();
}

/** Finishes package initialization such as setting up observers, events, styles, etc... */
function finishInitialize() {
  subs.add(atom.workspace.getLeftDock().observeVisible(function (visible) {
    leftDockVisible = visible;
    updatePadding();
  }), atom.workspace.getRightDock().observeVisible(function (_) {
    return updatePadding();
  }), atom.config.observe('no-title-bar.trafficLightsPadding', function () {
    return updatePadding();
  }), atom.config.observe('no-title-bar.automaticTrafficLightsPadding', function () {
    return updatePadding();
  }));

  if (atom.config.get('no-title-bar.enableLiberalWindowDragging')) {
    setupLiberalWindowDragging();
  }

  setupDockWorkaround('left');
  setupDockWorkaround('right');
}

/** Workaround window drag issues when there are scrolled panels in side docks.
  *
  * When a the content in a panel in a dock, like the tree-view, is scrolled
  * beyond the height of the window, webkit-app-region drag stops working.
  * To get around this we overlay a hidden element on top of the dock padding,
  * and set its webkit-app-region. For now, this seems to work ok.
  */
function setupDockWorkaround(side) {
  __guard__(document.querySelector(['atom-workspace', 'atom-workspace-axis.horizontal'
  // Putting the element in the side panel container prevents scrolling in the
  // dock contents from interfering with dragging. However, scrolling in the
  // editor's tab-bar can also interfere. So we must put our workaround
  // elements up one level from those containers.
  // `atom-panel-container.${side}`
  ].join(' ')), function (hook) {
    var pos = side === 'left' ? 0 : 1;

    // create a new invisible element specifically for window dragging
    dockWorkaroundElements[pos] = document.createElement('div');
    dockWorkaroundElements[pos].classList.add('no-title-bar-' + side + '-dock-workaround');
    dockWorkaroundElements[pos].style.webkitAppRegion = 'drag';
    dockWorkaroundElements[pos].style.position = 'absolute';
    dockWorkaroundElements[pos].style.top = '0';
    if (side === 'left') dockWorkaroundElements[pos].style.left = '0';else dockWorkaroundElements[pos].style.right = '0';
    hook.appendChild(dockWorkaroundElements[pos]);
    subs.add(new _atom.Disposable(function () {
      return dockWorkaroundElements[pos].remove();
    }));

    // watch for dock resize events so we can adjust our drag element
    var m = side === 'left' ? new MutationObserver(function (_) {
      return adjustDockWorkaroundElement('left');
    }) : new MutationObserver(function (_) {
      return adjustDockWorkaroundElement('right');
    });
    var dock = side === 'left' ? atom.views.getView(atom.workspace.getLeftDock()).querySelector('div.atom-dock-mask') : atom.views.getView(atom.workspace.getRightDock()).querySelector('div.atom-dock-mask');
    m.observe(dock, { attributes: true, attributeFilter: ['style'] });
    dockWorkaroundObservers[pos] = m;
    subs.add(new _atom.Disposable(function () {
      return dockWorkaroundObservers[pos].disconnect();
    }));
  });
}

/** Returns true iff your platform can support no-title-bar. */

function enabledForPlatform(platform) {
  return document.body.classList.contains('platform-' + platform);
}

/** Creates and installs a stylesheet to enable global window dragging. */
function setupLiberalWindowDragging() {
  var s = document.createElement('style');
  s.type = 'text/css';
  s.innerText = '\n    .no-title-bar:not(.fullscreen) > atom-workspace { -webkit-app-region: drag; }\'\n  ';
  document.querySelector('head atom-styles').appendChild(s);
  subs.add(new _atom.Disposable(function () {
    return s.parentNode.removeChild(s);
  }));
}

/** Sets the left padding width to accomodate window traffic lights. */
function setPadding(width) {
  adjustDockWorkaroundElement('left');
  adjustDockWorkaroundElement('right');

  var tabBarPaddingSelector = '.no-title-bar:not(.fullscreen):not(.hidden-title-bar)\n    atom-panel-container.left + atom-workspace-axis.vertical\n    .pane:nth-child(1)\n    .tab-bar\n  ';
  var found = __guard__(document.querySelector(tabBarPaddingSelector), function (element) {
    if (width !== null) element.style.paddingLeft = width + 'px';else element.style.paddingLeft = '';
    return true;
  });
  if (found !== undefined) return found;
  return false;
}

/** Correctly fit the dock workaround element into its dock container. */
function adjustDockWorkaroundElement(side) {
  var pos = side === 'left' ? 0 : 1;

  __guard__(dockWorkaroundTimeout[pos], function (x) {
    clearTimeout(dockWorkaroundTimeout[pos]);
    dockWorkaroundTimeout[pos] = null;
  });

  var dockWoraroundTimeoutResponseTime = 500; // ms
  dockWorkaroundTimeout[pos] = setTimeout(function () {
    var element = dockWorkaroundElements[pos];
    if (element) {
      __guard__(document.querySelector(['.no-title-bar:not(.fullscreen).custom-title-bar', '>', 'atom-workspace', 'atom-panel-container.' + side].join(' ')), function (panel) {
        element.style.height = window.getComputedStyle(panel).marginTop;
        element.style.width = window.getComputedStyle(panel).width;
      });
    }
  }, dockWoraroundTimeoutResponseTime);
}

/** Calls setPadding() with the correct value width value for Atom's current state. */
function updatePadding() {
  if (leftDockVisible) {
    return setPadding(0);
  }

  if (atom.config.get('no-title-bar.automaticTrafficLightsPadding')) {
    var width = __guard__(atom.workspace.getLeftDock(), function (x) {
      return x.state.size;
    });
    if (width) {
      var offset = atom.config.get('no-title-bar.automaticTrafficLightsPaddingOffset');
      return setPadding(width + offset);
    }
  }

  return setPadding(atom.config.get('no-title-bar.trafficLightsPadding'));
}

function __guard__(value, transform) {
  return typeof value !== 'undefined' && value !== null ? transform(value) : undefined;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9DcmlzRm9ybm8vZG90ZmlsZXMvLmF0b20vcGFja2FnZXMvbm8tdGl0bGUtYmFyL2xpYi9uby10aXRsZS1iYXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7b0JBRThDLE1BQU07O0FBRXBELElBQUksc0JBQXNCLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7QUFDekMsSUFBSSx1QkFBdUIsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUMxQyxJQUFJLHFCQUFxQixHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ3hDLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQTtBQUMzQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7O0FBRVIsU0FBUyxRQUFRLENBQUUsS0FBSyxFQUFFO0FBQy9CLE1BQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTTtBQUNqRCxNQUFJLEdBQUcsK0JBQXlCLENBQUE7O0FBRWhDLFVBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUMzQyxNQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFlLFlBQU07QUFDNUIsY0FBVSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ2hCLFlBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQTtHQUMvQyxDQUFDLENBQUMsQ0FBQTs7O0FBR0gsTUFBSSxnQkFBZ0IsR0FBRyxJQUFJLGdCQUFnQixDQUFDLFVBQUMsU0FBUyxFQUFLO0FBQ3pELFFBQUksZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLENBQUE7QUFDbkQsb0JBQWdCLEdBQUcsSUFBSSxDQUFBO0FBQ3ZCLG9CQUFnQixFQUFFLENBQUE7R0FDbkIsQ0FBQyxDQUFBO0FBQ0Ysa0JBQWdCLENBQUMsT0FBTyxDQUFDLElBQUks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SyxJQUFJLEdBQ2xELFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FDaEIsU0FBUyxDQUFBO0NBQ2QiLCJmaWxlIjoiL1VzZXJzL0NyaXNGb3Juby9kb3RmaWxlcy8uYXRvbS9wYWNrYWdlcy9uby10aXRsZS1iYXIvbGliL25vLXRpdGxlLWJhci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBAYmFiZWwgKi9cblxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuXG5sZXQgZG9ja1dvcmthcm91bmRFbGVtZW50cyA9IFtudWxsLCBudWxsXVxubGV0IGRvY2tXb3JrYXJvdW5kT2JzZXJ2ZXJzID0gW251bGwsIG51bGxdXG5sZXQgZG9ja1dvcmthcm91bmRUaW1lb3V0ID0gW251bGwsIG51bGxdXG5sZXQgbGVmdERvY2tWaXNpYmxlID0gZmFsc2VcbmxldCBzdWJzID0gbnVsbFxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUgKHN0YXRlKSB7XG4gIGlmICghZW5hYmxlZEZvclBsYXRmb3JtKHByb2Nlc3MucGxhdGZvcm0pKSByZXR1cm5cbiAgc3VicyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcblxuICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ25vLXRpdGxlLWJhcicpXG4gIHN1YnMuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICBzZXRQYWRkaW5nKG51bGwpXG4gICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCduby10aXRsZS1iYXInKVxuICB9KSlcblxuICAvLyB3YWl0IHRvIGZpbmlzaCBwYWNrYWdlIGluaXRpYWxpemF0aW9uIHVudGlsIGF0b20gaXMgZnVsbHkgbG9hZGVkXG4gIGxldCBtdXRhdGlvbk9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9ucykgPT4ge1xuICAgIGlmIChtdXRhdGlvbk9ic2VydmVyKSBtdXRhdGlvbk9ic2VydmVyLmRpc2Nvbm5lY3QoKVxuICAgIG11dGF0aW9uT2JzZXJ2ZXIgPSBudWxsXG4gICAgZmluaXNoSW5pdGlhbGl6ZSgpXG4gIH0pXG4gIG11dGF0aW9uT2JzZXJ2ZXIub2JzZXJ2ZShhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLCB7YXR0cmlidXRlczogdHJ1ZX0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlICgpIHtcbiAgaWYgKHN1YnMpIHN1YnMuZGlzcG9zZSgpXG59XG5cbi8qKiBGaW5pc2hlcyBwYWNrYWdlIGluaXRpYWxpemF0aW9uIHN1Y2ggYXMgc2V0dGluZyB1cCBvYnNlcnZlcnMsIGV2ZW50cywgc3R5bGVzLCBldGMuLi4gKi9cbmZ1bmN0aW9uIGZpbmlzaEluaXRpYWxpemUgKCkge1xuICBzdWJzLmFkZChcbiAgICBhdG9tLndvcmtzcGFjZS5nZXRMZWZ0RG9jaygpLm9ic2VydmVWaXNpYmxlKHZpc2libGUgPT4ge1xuICAgICAgbGVmdERvY2tWaXNpYmxlID0gdmlzaWJsZVxuICAgICAgdXBkYXRlUGFkZGluZygpXG4gICAgfSksXG4gICAgYXRvbS53b3Jrc3BhY2UuZ2V0UmlnaHREb2NrKCkub2JzZXJ2ZVZpc2libGUoXyA9PiB1cGRhdGVQYWRkaW5nKCkpLFxuICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ25vLXRpdGxlLWJhci50cmFmZmljTGlnaHRzUGFkZGluZycsICgpID0+IHVwZGF0ZVBhZGRpbmcoKSksXG4gICAgYXRvbS5jb25maWcub2JzZXJ2ZSgnbm8tdGl0bGUtYmFyLmF1dG9tYXRpY1RyYWZmaWNMaWdodHNQYWRkaW5nJywgKCkgPT4gdXBkYXRlUGFkZGluZygpKVxuICApXG5cbiAgaWYgKGF0b20uY29uZmlnLmdldCgnbm8tdGl0bGUtYmFyLmVuYWJsZUxpYmVyYWxXaW5kb3dEcmFnZ2luZycpKSB7XG4gICAgc2V0dXBMaWJlcmFsV2luZG93RHJhZ2dpbmcoKVxuICB9XG5cbiAgc2V0dXBEb2NrV29ya2Fyb3VuZCgnbGVmdCcpXG4gIHNldHVwRG9ja1dvcmthcm91bmQoJ3JpZ2h0Jylcbn1cblxuLyoqIFdvcmthcm91bmQgd2luZG93IGRyYWcgaXNzdWVzIHdoZW4gdGhlcmUgYXJlIHNjcm9sbGVkIHBhbmVscyBpbiBzaWRlIGRvY2tzLlxuICAqXG4gICogV2hlbiBhIHRoZSBjb250ZW50IGluIGEgcGFuZWwgaW4gYSBkb2NrLCBsaWtlIHRoZSB0cmVlLXZpZXcsIGlzIHNjcm9sbGVkXG4gICogYmV5b25kIHRoZSBoZWlnaHQgb2YgdGhlIHdpbmRvdywgd2Via2l0LWFwcC1yZWdpb24gZHJhZyBzdG9wcyB3b3JraW5nLlxuICAqIFRvIGdldCBhcm91bmQgdGhpcyB3ZSBvdmVybGF5IGEgaGlkZGVuIGVsZW1lbnQgb24gdG9wIG9mIHRoZSBkb2NrIHBhZGRpbmcsXG4gICogYW5kIHNldCBpdHMgd2Via2l0LWFwcC1yZWdpb24uIEZvciBub3csIHRoaXMgc2VlbXMgdG8gd29yayBvay5cbiAgKi9cbmZ1bmN0aW9uIHNldHVwRG9ja1dvcmthcm91bmQgKHNpZGUpIHtcbiAgX19ndWFyZF9fKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoW1xuICAgICdhdG9tLXdvcmtzcGFjZScsXG4gICAgJ2F0b20td29ya3NwYWNlLWF4aXMuaG9yaXpvbnRhbCdcbiAgICAvLyBQdXR0aW5nIHRoZSBlbGVtZW50IGluIHRoZSBzaWRlIHBhbmVsIGNvbnRhaW5lciBwcmV2ZW50cyBzY3JvbGxpbmcgaW4gdGhlXG4gICAgLy8gZG9jayBjb250ZW50cyBmcm9tIGludGVyZmVyaW5nIHdpdGggZHJhZ2dpbmcuIEhvd2V2ZXIsIHNjcm9sbGluZyBpbiB0aGVcbiAgICAvLyBlZGl0b3IncyB0YWItYmFyIGNhbiBhbHNvIGludGVyZmVyZS4gU28gd2UgbXVzdCBwdXQgb3VyIHdvcmthcm91bmRcbiAgICAvLyBlbGVtZW50cyB1cCBvbmUgbGV2ZWwgZnJvbSB0aG9zZSBjb250YWluZXJzLlxuICAgIC8vIGBhdG9tLXBhbmVsLWNvbnRhaW5lci4ke3NpZGV9YFxuICBdLmpvaW4oJyAnKSksIGhvb2sgPT4ge1xuICAgIGNvbnN0IHBvcyA9IHNpZGUgPT09ICdsZWZ0JyA/IDAgOiAxXG5cbiAgICAvLyBjcmVhdGUgYSBuZXcgaW52aXNpYmxlIGVsZW1lbnQgc3BlY2lmaWNhbGx5IGZvciB3aW5kb3cgZHJhZ2dpbmdcbiAgICBkb2NrV29ya2Fyb3VuZEVsZW1lbnRzW3Bvc10gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIGRvY2tXb3JrYXJvdW5kRWxlbWVudHNbcG9zXS5jbGFzc0xpc3QuYWRkKGBuby10aXRsZS1iYXItJHtzaWRlfS1kb2NrLXdvcmthcm91bmRgKVxuICAgIGRvY2tXb3JrYXJvdW5kRWxlbWVudHNbcG9zXS5zdHlsZS53ZWJraXRBcHBSZWdpb24gPSAnZHJhZydcbiAgICBkb2NrV29ya2Fyb3VuZEVsZW1lbnRzW3Bvc10uc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnXG4gICAgZG9ja1dvcmthcm91bmRFbGVtZW50c1twb3NdLnN0eWxlLnRvcCA9ICcwJ1xuICAgIGlmIChzaWRlID09PSAnbGVmdCcpIGRvY2tXb3JrYXJvdW5kRWxlbWVudHNbcG9zXS5zdHlsZS5sZWZ0ID0gJzAnXG4gICAgZWxzZSBkb2NrV29ya2Fyb3VuZEVsZW1lbnRzW3Bvc10uc3R5bGUucmlnaHQgPSAnMCdcbiAgICBob29rLmFwcGVuZENoaWxkKGRvY2tXb3JrYXJvdW5kRWxlbWVudHNbcG9zXSlcbiAgICBzdWJzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiBkb2NrV29ya2Fyb3VuZEVsZW1lbnRzW3Bvc10ucmVtb3ZlKCkpKVxuXG4gICAgLy8gd2F0Y2ggZm9yIGRvY2sgcmVzaXplIGV2ZW50cyBzbyB3ZSBjYW4gYWRqdXN0IG91ciBkcmFnIGVsZW1lbnRcbiAgICBsZXQgbSA9IChzaWRlID09PSAnbGVmdCcpXG4gICAgICA/IG5ldyBNdXRhdGlvbk9ic2VydmVyKF8gPT4gYWRqdXN0RG9ja1dvcmthcm91bmRFbGVtZW50KCdsZWZ0JykpXG4gICAgICA6IG5ldyBNdXRhdGlvbk9ic2VydmVyKF8gPT4gYWRqdXN0RG9ja1dvcmthcm91bmRFbGVtZW50KCdyaWdodCcpKVxuICAgIGNvbnN0IGRvY2sgPSAoc2lkZSA9PT0gJ2xlZnQnKVxuICAgICAgPyBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UuZ2V0TGVmdERvY2soKSkucXVlcnlTZWxlY3RvcignZGl2LmF0b20tZG9jay1tYXNrJylcbiAgICAgIDogYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlLmdldFJpZ2h0RG9jaygpKS5xdWVyeVNlbGVjdG9yKCdkaXYuYXRvbS1kb2NrLW1hc2snKVxuICAgIG0ub2JzZXJ2ZShkb2NrLCB7YXR0cmlidXRlczogdHJ1ZSwgYXR0cmlidXRlRmlsdGVyOiBbJ3N0eWxlJ119KVxuICAgIGRvY2tXb3JrYXJvdW5kT2JzZXJ2ZXJzW3Bvc10gPSBtXG4gICAgc3Vicy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4gZG9ja1dvcmthcm91bmRPYnNlcnZlcnNbcG9zXS5kaXNjb25uZWN0KCkpKVxuICB9KVxufVxuXG4vKiogUmV0dXJucyB0cnVlIGlmZiB5b3VyIHBsYXRmb3JtIGNhbiBzdXBwb3J0IG5vLXRpdGxlLWJhci4gKi9cbmV4cG9ydCBmdW5jdGlvbiBlbmFibGVkRm9yUGxhdGZvcm0gKHBsYXRmb3JtKSB7XG4gIHJldHVybiBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucyhgcGxhdGZvcm0tJHtwbGF0Zm9ybX1gKVxufVxuXG4vKiogQ3JlYXRlcyBhbmQgaW5zdGFsbHMgYSBzdHlsZXNoZWV0IHRvIGVuYWJsZSBnbG9iYWwgd2luZG93IGRyYWdnaW5nLiAqL1xuZnVuY3Rpb24gc2V0dXBMaWJlcmFsV2luZG93RHJhZ2dpbmcgKCkge1xuICBsZXQgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJylcbiAgcy50eXBlID0gJ3RleHQvY3NzJ1xuICBzLmlubmVyVGV4dCA9IGBcbiAgICAubm8tdGl0bGUtYmFyOm5vdCguZnVsbHNjcmVlbikgPiBhdG9tLXdvcmtzcGFjZSB7IC13ZWJraXQtYXBwLXJlZ2lvbjogZHJhZzsgfSdcbiAgYFxuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkIGF0b20tc3R5bGVzJykuYXBwZW5kQ2hpbGQocylcbiAgc3Vicy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4gcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHMpKSlcbn1cblxuLyoqIFNldHMgdGhlIGxlZnQgcGFkZGluZyB3aWR0aCB0byBhY2NvbW9kYXRlIHdpbmRvdyB0cmFmZmljIGxpZ2h0cy4gKi9cbmZ1bmN0aW9uIHNldFBhZGRpbmcgKHdpZHRoKSB7XG4gIGFkanVzdERvY2tXb3JrYXJvdW5kRWxlbWVudCgnbGVmdCcpXG4gIGFkanVzdERvY2tXb3JrYXJvdW5kRWxlbWVudCgncmlnaHQnKVxuXG4gIGNvbnN0IHRhYkJhclBhZGRpbmdTZWxlY3RvciA9IGAubm8tdGl0bGUtYmFyOm5vdCguZnVsbHNjcmVlbik6bm90KC5oaWRkZW4tdGl0bGUtYmFyKVxuICAgIGF0b20tcGFuZWwtY29udGFpbmVyLmxlZnQgKyBhdG9tLXdvcmtzcGFjZS1heGlzLnZlcnRpY2FsXG4gICAgLnBhbmU6bnRoLWNoaWxkKDEpXG4gICAgLnRhYi1iYXJcbiAgYFxuICBjb25zdCBmb3VuZCA9IF9fZ3VhcmRfXyhkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRhYkJhclBhZGRpbmdTZWxlY3RvciksIGVsZW1lbnQgPT4ge1xuICAgIGlmICh3aWR0aCAhPT0gbnVsbCkgZWxlbWVudC5zdHlsZS5wYWRkaW5nTGVmdCA9IHdpZHRoICsgJ3B4J1xuICAgIGVsc2UgZWxlbWVudC5zdHlsZS5wYWRkaW5nTGVmdCA9ICcnXG4gICAgcmV0dXJuIHRydWVcbiAgfSlcbiAgaWYgKGZvdW5kICE9PSB1bmRlZmluZWQpIHJldHVybiBmb3VuZFxuICByZXR1cm4gZmFsc2Vcbn1cblxuLyoqIENvcnJlY3RseSBmaXQgdGhlIGRvY2sgd29ya2Fyb3VuZCBlbGVtZW50IGludG8gaXRzIGRvY2sgY29udGFpbmVyLiAqL1xuZnVuY3Rpb24gYWRqdXN0RG9ja1dvcmthcm91bmRFbGVtZW50IChzaWRlKSB7XG4gIGNvbnN0IHBvcyA9IHNpZGUgPT09ICdsZWZ0JyA/IDAgOiAxXG5cbiAgX19ndWFyZF9fKGRvY2tXb3JrYXJvdW5kVGltZW91dFtwb3NdLCB4ID0+IHtcbiAgICBjbGVhclRpbWVvdXQoZG9ja1dvcmthcm91bmRUaW1lb3V0W3Bvc10pXG4gICAgZG9ja1dvcmthcm91bmRUaW1lb3V0W3Bvc10gPSBudWxsXG4gIH0pXG5cbiAgY29uc3QgZG9ja1dvcmFyb3VuZFRpbWVvdXRSZXNwb25zZVRpbWUgPSA1MDAgLy8gbXNcbiAgZG9ja1dvcmthcm91bmRUaW1lb3V0W3Bvc10gPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICBsZXQgZWxlbWVudCA9IGRvY2tXb3JrYXJvdW5kRWxlbWVudHNbcG9zXVxuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICBfX2d1YXJkX18oZG9jdW1lbnQucXVlcnlTZWxlY3RvcihbXG4gICAgICAgICcubm8tdGl0bGUtYmFyOm5vdCguZnVsbHNjcmVlbikuY3VzdG9tLXRpdGxlLWJhcicsXG4gICAgICAgICc+JyxcbiAgICAgICAgJ2F0b20td29ya3NwYWNlJyxcbiAgICAgICAgYGF0b20tcGFuZWwtY29udGFpbmVyLiR7c2lkZX1gXG4gICAgICBdLmpvaW4oJyAnKSksIHBhbmVsID0+IHtcbiAgICAgICAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYW5lbCkubWFyZ2luVG9wXG4gICAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYW5lbCkud2lkdGhcbiAgICAgIH0pXG4gICAgfVxuICB9LCBkb2NrV29yYXJvdW5kVGltZW91dFJlc3BvbnNlVGltZSlcbn1cblxuLyoqIENhbGxzIHNldFBhZGRpbmcoKSB3aXRoIHRoZSBjb3JyZWN0IHZhbHVlIHdpZHRoIHZhbHVlIGZvciBBdG9tJ3MgY3VycmVudCBzdGF0ZS4gKi9cbmZ1bmN0aW9uIHVwZGF0ZVBhZGRpbmcgKCkge1xuICBpZiAobGVmdERvY2tWaXNpYmxlKSB7XG4gICAgcmV0dXJuIHNldFBhZGRpbmcoMClcbiAgfVxuXG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ25vLXRpdGxlLWJhci5hdXRvbWF0aWNUcmFmZmljTGlnaHRzUGFkZGluZycpKSB7XG4gICAgY29uc3Qgd2lkdGggPSBfX2d1YXJkX18oYXRvbS53b3Jrc3BhY2UuZ2V0TGVmdERvY2soKSwgeCA9PiB4LnN0YXRlLnNpemUpXG4gICAgaWYgKHdpZHRoKSB7XG4gICAgICBjb25zdCBvZmZzZXQgPSBhdG9tLmNvbmZpZy5nZXQoJ25vLXRpdGxlLWJhci5hdXRvbWF0aWNUcmFmZmljTGlnaHRzUGFkZGluZ09mZnNldCcpXG4gICAgICByZXR1cm4gc2V0UGFkZGluZyh3aWR0aCArIG9mZnNldClcbiAgICB9XG4gIH1cblxuICByZXR1cm4gc2V0UGFkZGluZyhhdG9tLmNvbmZpZy5nZXQoJ25vLXRpdGxlLWJhci50cmFmZmljTGlnaHRzUGFkZGluZycpKVxufVxuXG5mdW5jdGlvbiBfX2d1YXJkX18gKHZhbHVlLCB0cmFuc2Zvcm0pIHtcbiAgcmV0dXJuICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlICE9PSBudWxsKVxuICAgID8gdHJhbnNmb3JtKHZhbHVlKVxuICAgIDogdW5kZWZpbmVkXG59XG4iXX0=