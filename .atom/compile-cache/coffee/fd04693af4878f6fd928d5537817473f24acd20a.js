(function() {
  var DEFAULT_INDENT, DEFAULT_WARN_FN, adjust_space;

  DEFAULT_INDENT = '    ';

  adjust_space = function(line) {
    var comment, muli_string, string_list;
    string_list = line.match(/(['"])[^\1]*?\1/g);
    muli_string = line.match(/\[(=*)\[([^\]\1\]]*)/);
    comment = line.match(/\-{2}[^\[].*$/);
    line = line.replace(/\s+/g, ' ');
    line = line.replace(/\s?(==|>=|<=|~=|[=><\+\*\/])\s?/g, ' $1 ');
    line = line.replace(/([^=e\-\(\s])\s?\-\s?([^\-\[])/g, '$1 - $2');
    line = line.replace(/([^\d])e\s?\-\s?([^\-\[])/g, '$1e - $2');
    line = line.replace(/,([^\s])/g, ', $1');
    line = line.replace(/\s+,/g, ',');
    line = line.replace(/(['"])[^\1]*?\1/g, function() {
      return string_list.shift();
    });
    if (muli_string && muli_string[0]) {
      line = line.replace(/\[(=*)\[([^\]\1\]]*)/, muli_string[0]);
    }
    if (comment && comment[0]) {
      line = line.replace(/\-{2}[^\[].*$/, comment[0]);
    }
    return line;
  };

  DEFAULT_WARN_FN = function(msg) {
    return console.log('WARNING:', msg);
  };

  module.exports = function(str, indent, warn_fn, opts) {
    var $currIndent, $extIndent, $lastIndent, $nextIndent, $prevLength, $template, eol, new_code;
    if (opts == null) {
      opts = {};
    }
    eol = (opts != null ? opts.eol : void 0) || '\n';
    indent = indent || DEFAULT_INDENT;
    warn_fn = typeof warn_fn === 'function' ? warn_fn : DEFAULT_WARN_FN;
    if (Number.isInteger(indent)) {
      indent = ' '.repeat(indent);
    }
    $currIndent = 0;
    $nextIndent = 0;
    $prevLength = 0;
    $extIndent = 0;
    $lastIndent = 0;
    $template = 0;
    new_code = str.split(/\r?\n/g).map(function(line, line_number) {
      var $brackets, $curly, $template_flag, $useful, arr, code, comment, new_line, raw_line, res1, res2;
      $template_flag = false;
      if ($template) {
        res2 = line.match(/\](=*)\]/);
        if (res2 && $template === res2[1].length + 1) {
          $template_flag = true;
          if ($template && !/]=*]$/.test(line)) {
            arr = line.split(/\]=*\]/, 2);
            comment = arr[0];
            code = arr[1];
            line = comment + ']' + '='.repeat($template - 1) + ']' + adjust_space(code);
            $template = 0;
          }
          $template = 0;
        } else {
          return line;
        }
      }
      res1 = line.match(/\[(=*)\[/);
      if (res1 && (!new RegExp("\\]" + ('='.repeat(res1[1].length)) + "\\]").test(line))) {
        $template = res1[1].length + 1;
      }
      if (!$template_flag) {
        line = line.trim();
        line = adjust_space(line);
      }
      if (!line.length) {
        return '';
      }
      raw_line = line;
      line = line.replace(/(['"])[^\1]*?\1/g, '');
      line = line.replace(/\s*--.+$/, '');
      if (/^((local )?function|repeat|while)\b/.test(line) && !/\bend\s*[\),;]*$/.test(line) || /\b(then|do)$/.test(line) && !/^elseif\b/.test(line) || /^if\b/.test(line) && /\bthen\b/.test(line) && !/\bend$/.test(line) || /\bfunction ?(?:\w+ )?\([^\)]*\)$/.test(line) && !/\bend$/.test(line)) {
        $nextIndent = $currIndent + 1;
      } else if (/^until\b/.test(line) || /^end\s*[\),;]*$/.test(line) || /^end\s*\)\s*\.\./.test(line) || /^else(if)?\b/.test(line) && /\bend$/.test(line)) {
        $nextIndent = --$currIndent;
      } else if (/^else\b/.test(line) || /^elseif\b/.test(line)) {
        $nextIndent = $currIndent;
        $currIndent = $currIndent - 1;
      }
      $brackets = (line.match(/\(/g) || []).length - (line.match(/\)/g) || []).length;
      $curly = (line.match(/\{/g) || []).length - (line.match(/\}/g) || []).length;
      if ($curly < 0) {
        $currIndent += $curly;
      }
      if ($brackets < 0) {
        $currIndent += $brackets;
      }
      $nextIndent += $brackets + $curly;
      if ($currIndent - $lastIndent > 1) {
        $extIndent += $nextIndent - $lastIndent - 1;
        $nextIndent = $currIndent = 1 + $lastIndent;
      }
      if ($currIndent - $lastIndent < -1 && $extIndent > 0) {
        $extIndent += $currIndent - $lastIndent + 1;
        $currIndent = -1 + $lastIndent;
      }
      if ($nextIndent < $currIndent) {
        $nextIndent = $currIndent;
      }
      if ($currIndent < 0) {
        warn_fn("negative indentation at line " + line_number + ": " + raw_line);
      }
      new_line = (raw_line.length && $currIndent > 0 && !$template_flag ? indent.repeat($currIndent) : '') + raw_line;
      $useful = $prevLength > 0 || raw_line.length > 0;
      $lastIndent = $currIndent;
      $currIndent = $nextIndent;
      $prevLength = raw_line.length;
      return new_line || void 0;
    });
    if ($currIndent > 0) {
      warn_fn('positive indentation at the end');
    }
    return new_code.join(eol);
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL1VzZXJzL0NyaXNGb3Juby9kb3RmaWxlcy8uYXRvbS9wYWNrYWdlcy9hdG9tLWJlYXV0aWZ5L3NyYy9iZWF1dGlmaWVycy9sdWEtYmVhdXRpZmllci9iZWF1dGlmaWVyLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUE7O0VBQUEsY0FBQSxHQUFpQjs7RUFFakIsWUFBQSxHQUFlLFNBQUMsSUFBRDtBQUNiLFFBQUE7SUFBQSxXQUFBLEdBQWMsSUFBSSxDQUFDLEtBQUwsQ0FBVyxrQkFBWDtJQUNkLFdBQUEsR0FBYyxJQUFJLENBQUMsS0FBTCxDQUFXLHNCQUFYO0lBQ2QsT0FBQSxHQUFVLElBQUksQ0FBQyxLQUFMLENBQVcsZUFBWDtJQUNWLElBQUEsR0FBTyxJQUFJLENBQUMsT0FBTCxDQUFhLE1BQWIsRUFBcUIsR0FBckI7SUFFUCxJQUFBLEdBQU8sSUFBSSxDQUFDLE9BQUwsQ0FBYSxrQ0FBYixFQUFpRCxNQUFqRDtJQUVQLElBQUEsR0FBTyxJQUFJLENBQUMsT0FBTCxDQUFhLGlDQUFiLEVBQWdELFNBQWhEO0lBQ1AsSUFBQSxHQUFPLElBQUksQ0FBQyxPQUFMLENBQWEsNEJBQWIsRUFBMkMsVUFBM0M7SUFFUCxJQUFBLEdBQU8sSUFBSSxDQUFDLE9BQUwsQ0FBYSxXQUFiLEVBQTBCLE1BQTFCO0lBRVAsSUFBQSxHQUFPLElBQUksQ0FBQyxPQUFMLENBQWEsT0FBYixFQUFzQixHQUF0QjtJQUVQLElBQUEsR0FBTyxJQUFJLENBQUMsT0FBTCxDQUFhLGtCQUFiLEVBQWlDLFNBQUE7YUFDdEMsV0FBVyxDQUFDLEtBQVosQ0FBQTtJQURzQyxDQUFqQztJQUVQLElBQUcsV0FBQSxJQUFnQixXQUFZLENBQUEsQ0FBQSxDQUEvQjtNQUNFLElBQUEsR0FBTyxJQUFJLENBQUMsT0FBTCxDQUFhLHNCQUFiLEVBQXFDLFdBQVksQ0FBQSxDQUFBLENBQWpELEVBRFQ7O0lBRUEsSUFB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QUFBLENBQVEsaUNBQVIsRUFBQTs7V0FDQSxRQUFRLENBQUMsSUFBVCxDQUFjLEdBQWQ7RUE1RWU7QUE1QmpCIiwic291cmNlc0NvbnRlbnQiOlsiREVGQVVMVF9JTkRFTlQgPSAnICAgICdcblxuYWRqdXN0X3NwYWNlID0gKGxpbmUpIC0+XG4gIHN0cmluZ19saXN0ID0gbGluZS5tYXRjaCAvKFsnXCJdKVteXFwxXSo/XFwxL2dcbiAgbXVsaV9zdHJpbmcgPSBsaW5lLm1hdGNoIC9cXFsoPSopXFxbKFteXFxdXFwxXFxdXSopL1xuICBjb21tZW50ID0gbGluZS5tYXRjaCAvXFwtezJ9W15cXFtdLiokL1xuICBsaW5lID0gbGluZS5yZXBsYWNlIC9cXHMrL2csICcgJ1xuICAjIHJlcGxhY2UgYWxsIHdoaXRlc3BhY2VzIGluc2lkZSB0aGUgc3RyaW5nIHdpdGggb25lIHNwYWNlLCBXQVJOSU5HOiB0aGUgd2hpdGVzcGFjZXMgaW4gc3RyaW5nIHdpbGwgYmUgcmVwbGFjZSB0b28hXG4gIGxpbmUgPSBsaW5lLnJlcGxhY2UgL1xccz8oPT18Pj18PD18fj18Wz0+PFxcK1xcKlxcL10pXFxzPy9nLCAnICQxICdcbiAgIyBhZGQgd2hpdGVzcGFjZSBhcm91bmQgdGhlIG9wZXJhdG9yXG4gIGxpbmUgPSBsaW5lLnJlcGxhY2UgLyhbXj1lXFwtXFwoXFxzXSlcXHM/XFwtXFxzPyhbXlxcLVxcW10pL2csICckMSAtICQyJ1xuICBsaW5lID0gbGluZS5yZXBsYWNlIC8oW15cXGRdKWVcXHM/XFwtXFxzPyhbXlxcLVxcW10pL2csICckMWUgLSAkMidcbiAgIyBqdXN0IGZvcm1hdCBtaW51cywgbm90IGZvciAtLSBvciBuZWdhdGl2ZSBudW1iZXIgb3IgY29tbWVudGFyeS5cbiAgbGluZSA9IGxpbmUucmVwbGFjZSAvLChbXlxcc10pL2csICcsICQxJ1xuICAjIGFkanVzdCAnLCdcbiAgbGluZSA9IGxpbmUucmVwbGFjZSAvXFxzKywvZywgJywnXG4gICMgcmVjb3ZlciB0aGUgd2hpdGVzcGFjZXMgaW4gc3RyaW5nLlxuICBsaW5lID0gbGluZS5yZXBsYWNlIC8oWydcIl0pW15cXDFdKj9cXDEvZywgLT5cbiAgICBzdHJpbmdfbGlzdC5zaGlmdCgpXG4gIGlmIG11bGlfc3RyaW5nIGFuZCBtdWxpX3N0cmluZ1swXVxuICAgIGxpbmUgPSBsaW5lLnJlcGxhY2UgL1xcWyg9KilcXFsoW15cXF1cXDFcXF1dKikvLCBtdWxpX3N0cmluZ1swXVxuICBpZiBjb21tZW50IGFuZCBjb21tZW50WzBdXG4gICAgbGluZSA9IGxpbmUucmVwbGFjZSAvXFwtezJ9W15cXFtdLiokLywgY29tbWVudFswXVxuICBsaW5lXG5cbkRFRkFVTFRfV0FSTl9GTiA9IChtc2cpIC0+XG4gIGNvbnNvbGUubG9nKCdXQVJOSU5HOicsIG1zZylcblxubW9kdWxlLmV4cG9ydHMgPSAoc3RyLCBpbmRlbnQsIHdhcm5fZm4sIG9wdHMgPSB7fSkgLT5cbiAgZW9sID0gb3B0cz8uZW9sIG9yICdcXG4nXG4gIGluZGVudCA9IGluZGVudCBvciBERUZBVUxUX0lOREVOVFxuICB3YXJuX2ZuID0gaWYgdHlwZW9mIHdhcm5fZm4gPT0gJ2Z1bmN0aW9uJyB0aGVuIHdhcm5fZm4gZWxzZSBERUZBVUxUX1dBUk5fRk5cbiAgaW5kZW50ID0gJyAnLnJlcGVhdChpbmRlbnQpIGlmIE51bWJlci5pc0ludGVnZXIoaW5kZW50KVxuICAkY3VyckluZGVudCA9IDBcbiAgJG5leHRJbmRlbnQgPSAwXG4gICRwcmV2TGVuZ3RoID0gMFxuICAkZXh0SW5kZW50ID0gMFxuICAkbGFzdEluZGVudCA9IDBcbiAgJHRlbXBsYXRlID0gMFxuICBuZXdfY29kZSA9IHN0ci5zcGxpdCgvXFxyP1xcbi9nKS5tYXAgKGxpbmUsIGxpbmVfbnVtYmVyKSAtPlxuICAgICR0ZW1wbGF0ZV9mbGFnID0gZmFsc2VcbiAgICBpZiAkdGVtcGxhdGVcbiAgICAgIHJlczIgPSBsaW5lLm1hdGNoKC9cXF0oPSopXFxdLylcbiAgICAgIGlmIHJlczIgYW5kICR0ZW1wbGF0ZSA9PSByZXMyWzFdLmxlbmd0aCArIDFcbiAgICAgICAgJHRlbXBsYXRlX2ZsYWcgPSB0cnVlXG4gICAgICAgIGlmICR0ZW1wbGF0ZSBhbmQgIS9dPSpdJC8udGVzdChsaW5lKVxuICAgICAgICAgIGFyciA9IGxpbmUuc3BsaXQoL1xcXT0qXFxdLywgMilcbiAgICAgICAgICBjb21tZW50ID0gYXJyWzBdXG4gICAgICAgICAgY29kZSA9IGFyclsxXVxuICAgICAgICAgIGxpbmUgPSBjb21tZW50ICsgJ10nICsgJz0nLnJlcGVhdCgkdGVtcGxhdGUgLSAxKSArICddJyArIGFkanVzdF9zcGFjZShjb2RlKVxuICAgICAgICAgICR0ZW1wbGF0ZSA9IDBcbiAgICAgICAgJHRlbXBsYXRlID0gMFxuICAgICAgZWxzZVxuICAgICAgICByZXR1cm4gbGluZVxuICAgIHJlczEgPSBsaW5lLm1hdGNoKC9cXFsoPSopXFxbLylcbiAgICBpZiByZXMxIGFuZCAobm90IG5ldyBSZWdFeHAoXCJcXFxcXSN7Jz0nLnJlcGVhdCByZXMxWzFdLmxlbmd0aH1cXFxcXVwiKS50ZXN0IGxpbmUpXG4gICAgICAkdGVtcGxhdGUgPSByZXMxWzFdLmxlbmd0aCArIDFcbiAgICBpZiAhJHRlbXBsYXRlX2ZsYWdcbiAgICAgIGxpbmUgPSBsaW5lLnRyaW0oKVxuICAgICAgIyByZW1vdGUgYWxsIHNwYWNlcyBvbiBib3RoIGVuZHNcbiAgICAgIGxpbmUgPSBhZGp1c3Rfc3BhY2UobGluZSlcbiAgICBpZiAhbGluZS5sZW5ndGhcbiAgICAgIHJldHVybiAnJ1xuICAgIHJhd19saW5lID0gbGluZVxuICAgIGxpbmUgPSBsaW5lLnJlcGxhY2UoLyhbJ1wiXSlbXlxcMV0qP1xcMS9nLCAnJylcbiAgICAjIHJlbW92ZSBhbGwgcXVvdGVkIGZyYWdtZW50cyBmb3IgcHJvcGVyIGJyYWNrZXQgcHJvY2Vzc2luZ1xuICAgIGxpbmUgPSBsaW5lLnJlcGxhY2UoL1xccyotLS4rJC8sICcnKVxuICAgICMgcmVtb3ZlIGFsbCBjb21tZW50czsgdGhpcyBpZ25vcmVzIGxvbmcgYnJhY2tldCBzdHlsZSBjb21tZW50c1xuICAgIGlmIC9eKChsb2NhbCApP2Z1bmN0aW9ufHJlcGVhdHx3aGlsZSlcXGIvLnRlc3QobGluZSkgYW5kICEvXFxiZW5kXFxzKltcXCksO10qJC8udGVzdChsaW5lKSBvciAvXFxiKHRoZW58ZG8pJC8udGVzdChsaW5lKSBhbmQgIS9eZWxzZWlmXFxiLy50ZXN0KGxpbmUpIG9yIC9eaWZcXGIvLnRlc3QobGluZSkgYW5kIC9cXGJ0aGVuXFxiLy50ZXN0KGxpbmUpIGFuZCAhL1xcYmVuZCQvLnRlc3QobGluZSkgb3IgL1xcYmZ1bmN0aW9uID8oPzpcXHcrICk/XFwoW15cXCldKlxcKSQvLnRlc3QobGluZSkgYW5kICEvXFxiZW5kJC8udGVzdChsaW5lKVxuICAgICAgJG5leHRJbmRlbnQgPSAkY3VyckluZGVudCArIDFcbiAgICBlbHNlIGlmIC9edW50aWxcXGIvLnRlc3QobGluZSkgb3IgL15lbmRcXHMqW1xcKSw7XSokLy50ZXN0KGxpbmUpIG9yIC9eZW5kXFxzKlxcKVxccypcXC5cXC4vLnRlc3QobGluZSkgb3IgL15lbHNlKGlmKT9cXGIvLnRlc3QobGluZSkgYW5kIC9cXGJlbmQkLy50ZXN0KGxpbmUpXG4gICAgICAkbmV4dEluZGVudCA9IC0tJGN1cnJJbmRlbnRcbiAgICBlbHNlIGlmIC9eZWxzZVxcYi8udGVzdChsaW5lKSBvciAvXmVsc2VpZlxcYi8udGVzdChsaW5lKVxuICAgICAgJG5leHRJbmRlbnQgPSAkY3VyckluZGVudFxuICAgICAgJGN1cnJJbmRlbnQgPSAkY3VyckluZGVudCAtIDFcbiAgICAkYnJhY2tldHMgPSAobGluZS5tYXRjaCgvXFwoL2cpIG9yIFtdKS5sZW5ndGggLSAoKGxpbmUubWF0Y2goL1xcKS9nKSBvciBbXSkubGVuZ3RoKVxuICAgICMgY2FwdHVyZSB1bmJhbGFuY2VkIGJyYWNrZXRzXG4gICAgJGN1cmx5ID0gKGxpbmUubWF0Y2goL1xcey9nKSBvciBbXSkubGVuZ3RoIC0gKChsaW5lLm1hdGNoKC9cXH0vZykgb3IgW10pLmxlbmd0aClcbiAgICAjIGNhcHR1cmUgdW5iYWxhbmNlZCBjdXJseSBicmFja2V0c1xuICAgICMgY2xvc2UgKGN1cmx5KSBicmFja2V0cyBpZiBuZWVkZWRcbiAgICBpZiAkY3VybHkgPCAwXG4gICAgICAkY3VyckluZGVudCArPSAkY3VybHlcbiAgICBpZiAkYnJhY2tldHMgPCAwXG4gICAgICAkY3VyckluZGVudCArPSAkYnJhY2tldHNcbiAgICAkbmV4dEluZGVudCArPSAkYnJhY2tldHMgKyAkY3VybHlcbiAgICAjIGNvbnNvbGUubG9nKHtsYXN0OiAkbGFzdEluZGVudCwgY3VycjogJGN1cnJJbmRlbnQsIG5leHQ6ICRuZXh0SW5kZW50LCBleHQ6ICRleHRJbmRlbnR9KVxuICAgIGlmICRjdXJySW5kZW50IC0gJGxhc3RJbmRlbnQgPiAxXG4gICAgICAkZXh0SW5kZW50ICs9ICRuZXh0SW5kZW50IC0gJGxhc3RJbmRlbnQgLSAxXG4gICAgICAkbmV4dEluZGVudCA9ICRjdXJySW5kZW50ID0gMSArICRsYXN0SW5kZW50XG4gICAgaWYgJGN1cnJJbmRlbnQgLSAkbGFzdEluZGVudCA8IC0xIGFuZCAkZXh0SW5kZW50ID4gMFxuICAgICAgJGV4dEluZGVudCArPSAkY3VyckluZGVudCAtICRsYXN0SW5kZW50ICsgMVxuICAgICAgJGN1cnJJbmRlbnQgPSAtMSArICRsYXN0SW5kZW50XG4gICAgaWYgJG5leHRJbmRlbnQgPCAkY3VyckluZGVudFxuICAgICAgJG5leHRJbmRlbnQgPSAkY3VyckluZGVudFxuICAgICMgY29uc29sZS5sb2coe2xhc3Q6ICRsYXN0SW5kZW50LCBjdXJyOiAkY3VyckluZGVudCwgbmV4dDogJG5leHRJbmRlbnQsIGV4dDogJGV4dEluZGVudH0pXG4gICAgd2Fybl9mbiBcIlwiXCJuZWdhdGl2ZSBpbmRlbnRhdGlvbiBhdCBsaW5lICN7bGluZV9udW1iZXJ9OiAje3Jhd19saW5lfVwiXCJcIiBpZiAkY3VyckluZGVudCA8IDBcbiAgICBuZXdfbGluZSA9IChpZiByYXdfbGluZS5sZW5ndGggYW5kICRjdXJySW5kZW50ID4gMCBhbmQgISR0ZW1wbGF0ZV9mbGFnIHRoZW4gaW5kZW50LnJlcGVhdCgkY3VyckluZGVudCkgZWxzZSAnJykgKyByYXdfbGluZVxuICAgICR1c2VmdWwgPSAkcHJldkxlbmd0aCA+IDAgb3IgcmF3X2xpbmUubGVuZ3RoID4gMFxuICAgICRsYXN0SW5kZW50ID0gJGN1cnJJbmRlbnRcbiAgICAkY3VyckluZGVudCA9ICRuZXh0SW5kZW50XG4gICAgJHByZXZMZW5ndGggPSByYXdfbGluZS5sZW5ndGhcbiAgICBuZXdfbGluZSBvciB1bmRlZmluZWRcblxuICB3YXJuX2ZuICdwb3NpdGl2ZSBpbmRlbnRhdGlvbiBhdCB0aGUgZW5kJyBpZiAkY3VyckluZGVudCA+IDBcbiAgbmV3X2NvZGUuam9pbiBlb2wiXX0=
